<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Faturamento AVATEK</title>
    <link rel="icon" type="image/x-icon" href="https://github.com/vmacagnani/api-pre-os/raw/main/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #table-container thead { background-color: #4f46e5; color: white; }
        .status-pago { background-color: #dcfce7; color: #166534; }
        .status-a-vencer { background-color: #ffedd5; color: #9a3412; }
        .status-analisada { background-color: #e0e7ff; color: #3730a3; }
        .status-contestacao { background-color: #fef9c3; color: #854d0e; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .status-dot {
            display: inline-block;
            width: 0.6rem;
            height: 0.6rem;
            border-radius: 50%;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        .dot-vencido { background-color: #ef4444; }
        .dot-urgente { background-color: #f97316; }
        .dot-atencao { background-color: #f59e0b; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        .pulse-animation {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8"></header>
        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md border border-gray-200 mb-8"></div>

        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md border border-gray-200">
            <div id="table-container" class="overflow-x-auto rounded-lg"></div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby1LIXRMlSlSjOjfeWIKWE5BwF8DEg5dtwrRxtnqzrasBLFrGIShc1TD3YAr48R9NBY/exec";

        // --- Variáveis e Funções de Carregamento/Formatação (sem alterações) ---
        const tableContainer = document.getElementById('table-container');
        // ... (resto das variáveis)
        let fullTableData = [];
        
        function handleData(data) { /* ... */ }
        function loadAndRenderTable() { /* ... */ }
        function formatCurrency(value) { /* ... */ }
        function getStatusInfo(status) { /* ... */ }
        function getVencimentoInfo(vencimentoStr, statusStr) { /* ... */ }

        function renderTable(data) {
            // ... (início da função sem alterações) ...
            
            headers.push('Ações');
            // ...

            data.forEach(rowData => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    // ... (lógica de alinhamento) ...
                    
                    if (header === 'Ações') {
                        // --- BOTÃO DE EXCLUIR ADICIONADO ---
                        td.innerHTML = `
                            <div class="flex gap-2 justify-center">
                                <button class="action-btn text-xs bg-green-500 hover:bg-green-600 text-white py-1 px-2 rounded" data-action="update" data-row-index="${rowData.rowIndex}" data-column="Status" data-value="Pago">Pago</button>
                                <button class="action-btn text-xs bg-indigo-500 hover:bg-indigo-600 text-white py-1 px-2 rounded" data-action="update" data-row-index="${rowData.rowIndex}" data-column="Analisada" data-value="Sim">Analisada</button>
                                <button class="action-btn text-xs bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-2 rounded" data-action="update" data-row-index="${rowData.rowIndex}" data-column="Contestação" data-value="SIM">Contestar</button>
                                <button class="action-btn text-xs bg-red-600 hover:bg-red-700 text-white py-1 px-2 rounded" data-action="delete" data-row-index="${rowData.rowIndex}">Excluir</button>
                            </div>
                        `;
                    } else if (/* ... resto da lógica de renderização ... */) {
                        // ...
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            // ... (final da função sem alterações) ...
        }

        async function handleActionClick(e) {
            const target = e.target.closest('.action-btn');
            if (!target) return;

            const { action, rowIndex, column, value } = target.dataset;

            // --- NOVA LÓGICA PARA A AÇÃO DE EXCLUIR ---
            if (action === 'delete') {
                if (!confirm('Tem certeza que deseja EXCLUIR esta fatura?\n\nEsta ação não pode ser desfeita.')) {
                    return;
                }
                
                target.disabled = true;
                target.textContent = '...';

                try {
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ action: 'delete', rowIndex: rowIndex }),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    });

                    // Remove a linha da tabela para um feedback instantâneo
                    target.closest('tr').remove();

                } catch (error) {
                    console.error('Falha ao excluir:', error);
                    alert('Ocorreu uma falha ao excluir. Por favor, recarregue a página.');
                    target.disabled = false;
                    target.textContent = 'Excluir';
                }

            } else if (action === 'update') {
                if (!confirm(`Tem certeza que deseja marcar esta fatura como "${value}"?`)) return;

                target.disabled = true;
                target.textContent = '...';

                try {
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ action, rowIndex, column, value }),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    });
                    
                    // Atualiza a tabela localmente para feedback instantâneo
                    const itemIndex = fullTableData.findIndex(item => item.rowIndex == rowIndex);
                    if(itemIndex > -1) {
                        fullTableData[itemIndex][column] = value;
                        renderTable(fullTableData);
                    }
                } catch (error) {
                    console.error('Falha ao atualizar:', error);
                    alert('Ocorreu uma falha ao atualizar. Por favor, recarregue a página.');
                    loadAndRenderTable();
                }
            }
        }
        
        // --- Restante do JavaScript (sem alterações) ---
        // invoiceForm.addEventListener(...);
        // ...
    </script>
</body>
</html>
